= Camel Quarkus Product

* This Maven Module should never leak to the ASF repo

== `camel-quarkus-product-source.json`

* The format of `camel-quarkus-product-source.json` is under our control and independent from `camel-quarkus-product.json` which is controlled by Quarkus.
* We want to be able to have additional info in `camel-quarkus-product-source.json`, that we can use e.g. when doing partial productization or generating parts of our documentation.

=== Schema

* `extensions` - a map from extension artifactIds to extension metadata.
  Only productized extensions are listed here.
  This list actually controls which modules get unlinked from the source tree by `cq-prod-maven-plugin:prod-excludes` mojo.
* `extensions.<artifactId>.allowedMixedTests` - if defined and set to a non-empty array of artifactIds,
  accept the mixed tests covering the given extension.
* `extensions.<artifactId>.[jvm|native]` - The support status: possible values: `community`, `techPreview`, `supported`
* `extensions.<artifactId>.comment` - A free form comment
* `additionalProductizedArtifacts` - an array of artifactIds to include in the product build.
  Unlike `extensions.<artifactId>`, these are not extensions.
* `excludeTests` - an array of test module artifactIds.
  The associated test modules won't be linked in any group under `product/integration-tests-*` and they also be excluded in the config of `rpkgtests-maven-plugin` in `tooling/test-list/pom.xml`
* `versionTransformations` - a map from a version property (such as `kafka.version`) to a freemarker template that somehow transforms the version value.
  The input version is available through the `version` key.
  E.g. to remove the `.redhat*` suffix from a version, the freemarker template would look like the following `${version?replace('\\\\.redhat-.*$', '', 'r')}`. Note that four backslashes are there to first escape for JSON, then for Freemarker and finally for the Java regular expression.
  `versionTransformations` is honored only by both `mvn cq:sync-versions -N -e` and `mvn org.l2x6.cq:cq-prod-maven-plugin:prod-excludes -N`.
* `guideUrlTemplate` - a template for generating a URL pointing at a guide of the given extension in the CEQ product documentation.
  It allows for the following placeholders:
** `${cqMajorVersion}` - the major version of the Camel Quarkus release the URL applies to
** `${artifactIdBase}` - the base of the artifactId of the given extension; e.g. if the extension artifactId is `camel-quarkus-activemq` then the `artifactIdBase` would be `activemq`.
* `integrationTests` - A list of ``org.apache.maven.shared.utils.io.DirectoryScanner``s selecting integration test `pom.xml` files. Example:
+
[source,yaml]
----
    "integrationTests": [
        {
            "basedir": ".", // optional, relative to ${maven.multiModuleProjectDirectory}
            "includes": [
                "integration-tests/*/pom.xml",
                "integration-test-groups/*/*/pom.xml",
                "integration-tests-jvm/*/pom.xml"
            ],
            "excludes": [
                "integration-tests/messaging/pom.xml",
                "integration-tests/*-grouped/pom.xml"
            ]
        }
    ]
----
+
* `requiredProductizedCamelArtifacts` - a path relative to `${maven.multiModuleProjectDirectory}` where to write a list of Camel artifacts required by Camel Quarkus productized extensions. It is a text file one artifactId per line.
* `productizedCamelQuarkusArtifacts` - a path relative to `${maven.multiModuleProjectDirectory}` where to write a list of Camel artifacts required by Camel Quarkus productized extensions. It is a text file one artifactId per line.
* `availableCiNodes` - Number of nodes available to the CI. The tests will be split into as many groups. Default: 10
* `jenkinsfile` - Path to Jenkinsfile containing `// %generated-stages-start%` and `// %generated-stages-end%` relative to `${maven.multiModuleProjectDirectory}`
* `jenkinsfileStageTemplate` - a path to Jenkinsfile stage template relative to `${maven.multiModuleProjectDirectory}`
* `productizedDependenciesFile` - a path relative to `${maven.multiModuleProjectDirectory}` where to write a list of runtime dependencies of all Camel Quarkus productized extensions. It is a text file one artifactId per line. Default: `product/src/main/generated/transitive-dependencies-productized.txt`
* `allDependenciesFile` - a path relative to `${maven.multiModuleProjectDirectory}` where to write a list of all runtime dependencies of all Camel Quarkus extensions. It is a text file one artifactId per line. Default: `product/src/main/generated/transitive-dependencies-all.txt`
* `nonProductizedDependenciesPath` - a path relative to `${maven.multiModuleProjectDirectory}` where to write a list of runtime dependencies of all Camel Quarkus non-productized extensions. It is a text file one artifactId per line. Default: `product/src/main/generated/transitive-dependencies-non-productized.txt`
* `additionalExtensionDependencies` - A map from Camel Quarkus artifactIds to comma separated list of `groupId:artifactId` patterns.
  Used for assigning shaded dependencies to a Camel Quarkus artifact when deciding whether the given transitive needs to get productized.


=== Updating the source tree after changing `camel-quarkus-product-source.json`

Run the following from the root directory of the source tree:

[source,shell]
----
$ mvn org.l2x6.cq:cq-prod-maven-plugin:prod-excludes -N
----

and commit the changes.

If `product/src/main/generated/required-productized-camel-artifacts.txt` was changed
it needs to get copied to the corresponding Camel branch - the `product/README.adoc` in Camel.

Note that the consistency of the source tree with `camel-quarkus-product-source.json` is checked by
the `cq-prod-maven-plugin:prod-excludes-check` mojo bound to `validate` phase of the build.

The `transitive-deps` mojo needs to be run after `install` because it relies on Camel Quarkus artifacts and all their transitive dependencies being available in the local Maven repo at least.

=== The modified source tree

==== Build and test the productized part

The default profile-less build `mvn clean install` will include

* All productized extensions
* A mixed BOM
* Tests that cover productized extensions and have no non-productized dependencies.
  These tests can be run via `cd product/integration-tests-product && mvn verify -Pnative`.

Note that the default profile-less build `mvn clean install` will *not* include all tests
necessary to cover the productized extensions.
This is the case because some productized extensions are covered by tests requiring non-productized artifacts.
Those tests that are really essential for covering the productized extensions are called "allowed mixed tests".
They are explicitly marked via `extensions.<artifactId>.allowedMixedTests` in `camel-quarkus-product-source.json`.
To run them you need to

[source,shell]
----
$ cd product/integration-tests-mixed-allowed && mvn clean verify -Pmixed,native
----

==== Run the rest of the mixed tests

[source,shell]
----
$ cd product/integration-tests-mixed-jvm && mvn clean test -Pmixed
$ cd product/integration-tests-mixed-native && mvn clean verify -Pmixed,native
----

== `camel-quarkus-product.json`

* `target/camel-quarkus-product.json` is generated by `src/main/groovy/generate-camel-quarkus-product-json.groovy` from `src/main/resources/camel-quarkus-product-source.json`
* `target/camel-quarkus-product.json` is a list of Camel Quarkus extensions supported (or being tech-preview) in Camel Quarkus product
* `target/camel-quarkus-product.json` is used by Quarkus tooling in https://github.com/quarkusio/quarkus-platform[Quarkus Platform]

=== Testing documentation
You can read about test categorization and how to run specific test in link:testing.adoc[Testing documentation].
